<h2>Meet the Pod</h2>
<div id="members" class="card-container">
    <script>
        let fellows = []; // initialize array holding fellows

        // extract github usernames from fellows.yml
        {% for item in site.data.fellows %} 
            fellows.push({
                github: "{{ item.github }}",
                name: "{{ item.name }}",
                location: "{{ item.location }}",
                linkedin: "{{ item.linkedin }}",
                twitter: "{{ item.twitter }}",
                resum: "{{ item.resume }}",
                commits: 0,
                pullRequests: 0,
                issues: 0,
                comments: 0,
                total: 0,
            });
        {% endfor %}

        // get data from github
        async function getData(url) {
            const res = await fetch( url );
            const data = res.json();
            return data;
        }

        async function computeScore() {
            // count totoal commits per user
            const rawCommitdata = await getData("https://api.github.com/repos/MLH-Fellowship/prep-portfolio-22.AUG.PREP.2/stats/contributors");

            let commitData = rawCommitdata.reduce((obj, item) => (obj[item.author.html_url] = item.total, obj) ,{});

            // count created issues and PRs (closed ones) per user
            const rawClosedIssuesData = await getData("https://api.github.com/repos/MLH-Fellowship/prep-portfolio-22.AUG.PREP.2/issues?state=closed")
            
            let closedIssuesData = rawClosedIssuesData.reduce((obj, item) => {
                let prs = 0, issues = 0;
                
                prs = ((obj[item.user.html_url]) ? obj[item.user.html_url][0] : 0) + (item.pull_request != undefined)
                issues = ((obj[item.user.html_url]) ? obj[item.user.html_url][1] : 0) + !(item.pull_request != undefined)
                
                return (obj[item.user.html_url] = [prs, issues], obj)
            },
            {});
            
            // count created issues and PRs (opened ones) per user
            const rawOpenedIssuesData = await getData("https://api.github.com/repos/MLH-Fellowship/prep-portfolio-22.AUG.PREP.2/issues")
            
            let openedIssuesData = rawOpenedIssuesData.reduce((obj, item) => {
                let prs = 0, issues = 0;
                
                prs = ((obj[item.user.html_url]) ? obj[item.user.html_url][0] : 0) + (item.pull_request != undefined)
                issues = ((obj[item.user.html_url]) ? obj[item.user.html_url][1] : 0) + !(item.pull_request != undefined)
                
                return (obj[item.user.html_url] = [prs, issues], obj)
            },
            {});

            // Assign the number to each fellow and calculate total score
            for (const fellow of fellows) {
                fellow.commits = (!commitData[fellow.github]) ? 0 : commitData[fellow.github];
                
                let closedPRs = !(closedIssuesData[fellow.github]) ? 0 : closedIssuesData[fellow.github][0],
                    closedIusses = !(closedIssuesData[fellow.github]) ? 0 : closedIssuesData[fellow.github][1],
                    openedPRs = !(openedIssuesData[fellow.github]) ? 0: openedIssuesData[fellow.github][0],
                    openedIssues = !(openedIssuesData[fellow.github]) ? 0: openedIssuesData[fellow.github][1];

                fellow.pullRequests = closedPRs + openedPRs;
                fellow.issues = closedIusses + openedIssues;
                
                fellow.comments = 0; // TODO
                fellow.total = fellow.commits + fellow.pullRequests + fellow.issues + fellow.comments;
            }

            fellows.sort((a, b) => {
                return (a.total < b.total) ? 1 : ((b.total < a.total) ? -1 : 0);
            }); // sort fellows based on total commits

            const cardContainer = document.getElementsByClassName('card-container')[0];

            let fellowsHTML = "";
            let lock = 3;

            for (const fellow of fellows) {
                let img = '';

                if (lock && lock--) {
                    img = `<img src="./assets/img/icons/crown${3-lock}.png" class="card-badge" />`;
                }

                let cardHTML = `
                <div class="card">
                    <div class="info">
                        ${img}
                        <a href="/fellows/${fellow.name.replace(/ /g, '-')}">
                            <p class="title"> ${ fellow.name }</p>
                            <p class="location"> ${ fellow.location }</p>
                        <a>
                        <div class="icon">
                            <a ${(!fellow.github) ? "hidden" : ""} href=${fellow.github}>
                                <i class="fab fa-github fa-lg"></i>                    
                            </a>
                            <a ${(!fellow.twitter) ? "hidden" : ""} href=${fellow.twitter}>
                                <i class="fab fa-twitter fa-lg" style="color: #1DA1F2;"></i>                
                            </a>
                            <a ${(!fellow.resume) ? "hidden" : ""} href=${fellow.resume}>
                                <img class="social-link-icon" src="./assets/img/icons/resume.png">
                            </a>
                            <a ${(!fellow.linkedin) ? "hidden" : ""} href=${fellow.linkedin}>
                                <i class="fab fa-linkedin-in fa-lg" style="color: #0A66C2;"></i>
                            </a>
                        </div>
                        <p class="card-score">Score: ${ fellow.total }
                        <span class="card-score-breakdown">
                        Commits: ${fellow.commits}<br>
                        Pull requests: ${fellow.pullRequests}<br>
                        Issues: ${fellow.issues}<br>
                        Comments: ${fellow.comments}<br>
                        </span></p>
                    </div>
                </div>
                `
                fellowsHTML += cardHTML;
            }
            cardContainer.innerHTML += fellowsHTML;
        }

        computeScore();
    </script>
</div>